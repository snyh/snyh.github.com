GameObj=function(a,b){this.width=a;this.height=b;this.data=[];this.INF=1000};GameObj.prototype={shuffle:function(d){var b,a;for(var c=d.length;c;){b=Math.round(Math.random()*c);a=d[--c];d[c]=d[b];d[b]=a}return d},gen_data:function(){var d=[];var b=this.width*this.height-2*this.width-2*this.height+4;for(var c=0;c<b/2;c++){d.push(1+Math.round(Math.random()*15))}d=this.shuffle(d.concat(d));for(var e=0;e<this.height;e++){for(var a=0;a<this.width;a++){if(e==0||e==this.height-1||a==0||a==this.width-1){this.data[a+e*this.width]=0}else{this.data[a+e*this.width]=d.pop()}}}return this.data},get_path:function(c,a){this.dist=[];this.prev=[];this.visted=[];for(var b=0;b<this.width*this.height;b++){this.dist[b]=this.INF}this.dist[c]=0;this.dijkstra(c,a);var d=[];var b=this.prev[a];if(b===undefined){return[]}d.push(a);while(b!=c){d.push(b);b=this.prev[b];if(b==undefined){throw"get_path error!!!!"}}d.push(c);d=this.check_path(d);return d},check_path:function(j){var f=0;for(var c=2;c<j.length;c++){var h=j[c-2];var g=j[c];var b=h%this.width;var e=Math.floor(h/this.width);var a=g%this.width;var d=Math.floor(g/this.width);h=g;if(Math.abs(b-a)==1&&Math.abs(e-d)==1){f+=1;if(f>2){return[]}console.log(j)}}return j},erase_point:function(a){a.forEach(function(b){this.data[b]=0;this.data[b]=0})},dijkstra:function(b,c){var a=this.min_elem();while(a!=-1){if(a==c){this.prev[c]=a;break}if(c==a-1){this.prev[c]=a;break}this.relax(a,a-1);if(c==a+1){this.prev[c]=a;break}this.relax(a,a+1);if(c==a-this.width){this.prev[c]=a;break}this.relax(a,a-this.width);if(c==a+this.width){this.prev[c]=a;break}this.relax(a,a+this.width);this.visted[a]=1;a=this.min_elem()}},relax:function(j,h){if(h>this.data.length||h<0){return}var c=j%this.width;var g=Math.floor(j/this.width);var b=h%this.width;var f=Math.floor(h/this.width);if(Math.abs(c-b)+Math.abs(g-f)>2){return}var k=this.prev[j];var a=k%this.width;var e=Math.floor(k/this.width);var d=0;if(Math.abs(a-b)==1&&Math.abs(e-f)==1){d=5}var i=this.dist[j]+(this.data[h]===0?1:this.INF)+d;if(i<this.dist[h]){this.dist[h]=i;this.prev[h]=j}},min_elem:function(){var b=this.INF;var c=-1;for(var a=0;a<this.data.length;a++){if(this.visted[a]!=1&&this.dist[a]<b){b=this.dist[a];c=a}}return c},print:function(){var b=[];for(var c=0;c<this.data.length;){for(var a=0;a<this.width;a++){var e=c+a;b[this.data[e]]=b[this.data[e]]||0;b[this.data[e]]+=1}var d=c+this.width;console.log(this.data.slice(c,d));c=d}console.log("IMGS:"+b)},find_one_path:function(){var d=[];var c=[];for(var b=0;b<this.data.length;b++){if(this.data[b]!=0&&c[b]!=1){c[b]=1;for(var a=b+1;a<this.data.length;a++){if(this.data[a]!=0&&this.data[b]==this.data[a]){d=this.get_path(b,a,true);if(d.length>0){return[d[d.length-1],d[0]]}}}}}console.log("ERROR:");return[]}};DrawObj=function(a){this.ctx=a};DrawObj.prototype={roundRect:function(c,e,d,b,a){this.ctx.beginPath();a=3;this.ctx.moveTo(c,e);this.ctx.lineTo(c+d,e);this.ctx.lineTo(c+d,e+b);this.ctx.lineTo(c,e+b);this.ctx.closePath();this.ctx.fill()},progressBar:function(b,g,e,a,f,d){this.ctx.save();this.ctx.fillStyle="rgba(0, 0, 0, 0.2)";this.ctx.clearRect(b-10,g,e+20,a);this.ctx.fillRect(b-10,g,e+20,a);this.ctx.shadowOffsetX=2;this.ctx.shadowOffsetY=2;this.ctx.shadowBlur=5;this.ctx.shadowColor="#666";var c=this.ctx.createLinearGradient(0,g+a,0,0);c.addColorStop(0,"rgba(255,255,200, 0.1)");c.addColorStop(0.4,"rgba(255,255,200, 0.7)");c.addColorStop(1,"rgba(255,255,200,0.4)");this.ctx.fillStyle=c;this.roundRect(b,g,e,a);this.ctx.shadowColor="rgba(0,0,0,0)";this.ctx.fillStyle="green";this.ctx.fillText(f,13,a*(1-d)+28);this.ctx.lineJoin="round";this.ctx.lineWidth=5;this.ctx.strokeRect(b-5,a*(1-d)+10,e+10,25);this.ctx.restore()},};function is_in_rect(a,c,b){if(a>b[0]&&a<b[0]+b[2]&&c>b[1]&&c<b[1]+b[3]){return true}else{return false}}function LLK(){this.rect_score=[10,0,100,28];this.rect_pause=[160,0,85,28];this.rect_sound=[270,0,42,42];this.rect_level=[340,0,100,28];this.rect_title=[50,530,200,40];this.rect_msg=[280,550,110,40];this.init=function(a,b){this.width=a||10;this.height=b||12;this.data=[];this.cur_pos=-1;this.cur_img=-1;this.score=0;this.ctx=document.getElementById("view").getContext("2d");this.gobj=new GameObj(10,12);this.dobj=new DrawObj(this.ctx);this.has_sound=true;this.img_square=new Image();this.img_square.src="assets/img/is_32.png";this.img_soundon=new Image();this.img_soundon.src="assets/img/soundon.svg";this.img_soundoff=new Image();this.img_soundoff.src="assets/img/soundoff.svg";this.img_info=new Image();this.img_info.src="assets/img/info.svg";this.sound_ok=new Audio();this.sound_ok.src="assets/sound/effect.ogg";this.sound_error=new Audio();this.sound_error.src="assets/sound/error.ogg";var c=this;this.img_square.onload=function(){c.new_game(1)};this.img_soundon.onload=function(){c.draw_image(c.img_soundon,c.rect_sound)};this.bindclick()};this.new_game=function(a){this.data=this.gobj.gen_data();this.level=a;this.timeinit();this.removenum=0;this.timer_start();this.game_running=true;this.in_message=false;this.drawPage()};this.timeinit=function(){this.time=300-this.level*50;if(this.time<0){this.time=5}};this.timer_start=function(){var a=this;this.timer=setInterval(function(){a.time-=1;a.drawTimeBar();if(a.time<1){a.gameover()}},1000)};this.timer_stop=function(){clearInterval(this.timer)};this.msg_callback=function(){this.in_message=false;this.toggle_msg()};this.unbindclick=function(){$("#view").unbind("click")};this.bindclick=function(){var a=this;$("#view").click(function(f){var b=f.pageX-$("#view").offset().left;var h=f.pageY-$("#view").offset().top;if(a.in_message&&is_in_rect(b,h,a.rect_msg)){a.msg_callback()}if(is_in_rect(b,h,a.rect_pause)){a.toggle_game()}if(!a.game_running){return}if(is_in_rect(b,h,a.rect_sound)){a.toggle_sound()}var c=Math.floor(b/50);var g=Math.floor(h/50);var d=a.data[b+h*a.width];if(d==0||c==0||c==a.width-1||g==0||g==a.height-1){return}a.drawSelect(c,g)})};this.toggle_sound=function(){this.has_sound=!this.has_sound;if(this.has_sound){this.draw_image(this.img_soundon,this.rect_sound);this.sound_ok.play()}else{this.draw_image(this.img_soundoff,this.rect_sound)}};this.toggle_game=function(){this.game_running=!this.game_running;if(this.game_running){this.timer_start();this.drawPage()}else{this.timer_stop();this.message("游戏暂停中","继续",this.toggle_game)}};this.gameover=function(){this.timer_stop();this.game_running=false;this.message("游戏结束!","重来?",function(){this.score-=this.removenum*10;this.new_game(this.level)})};this.message=function(e,c,d){this.in_message=true;this.ctx.save();this.ctx.fillStyle="rgba(0, 0, 0, 0.7)";this.ctx.fillRect(0,0,480,600);this.ctx.fillStyle="rgba(0, 0, 0, 0.0)";this.ctx.shadowOffsetX=4;this.ctx.shadowOffsetY=4;this.ctx.shadowBlur=5;this.ctx.shadowColor="rgba(1, 1, 1, 0.4)";var a=this.rect_title;var b=this.rect_msg;this.ctx.fillStyle="rgba(255, 255, 255, 0.1)";this.ctx.fillRect(b[0],b[1],b[2],b[3]);this.ctx.fillStyle="rgba(0, 0, 0, 1)";this.ctx.font="normal 30px Arial";this.ctx.fillText(e,a[0],a[1]+50);this.ctx.fillStyle="rgba(255, 255, 0, 1)";this.ctx.fillText(c,b[0]+20,b[1]+30);this.ctx.restore();this.toggle_msg=d};this.gamewin=function(){this.game_running=false;this.timer_stop();this.message("挺不错嘛!","继续",function(){this.new_game(this.level+1)})};this.draw_out=function(d){var a=d%this.width;var c=Math.floor(d/this.width);var b=this.data[d];this.drawOne(b,a,c,40,40,0.6)};this.draw_norm=function(d){var a=d%this.width;var c=Math.floor(d/this.width);var b=this.data[d];this.drawOne(b,a,c,40,40,0.2)};this.drawOne=function(c,a,f,b,d,e){b=b||36;d=d||40;e=e||0.2;this.ctx.save();this.ctx.shadowOffsetX=3;this.ctx.shadowOffsetY=4;this.ctx.shadowBlur=5;this.ctx.shadowColor="rgba(0, 0, 0, "+e+")";this.ctx.fillStyle="rgba(0, 0, 0, "+e+")";this.ctx.clearRect(a*50,f*50,50,50);this.ctx.fillRect(a*50,f*50,50,50);this.ctx.drawImage(this.img_square,0,c*40,36,40,a*50,f*50,b,d);this.ctx.restore()};this.drawToolbar=function(){this.draw_text("Score: "+this.score,this.rect_score);this.draw_text("Level: "+this.level,this.rect_level);this.draw_text("Pause",this.rect_pause);this.drawTimeBar()};this.drawTimeBar=function(){this.dobj.progressBar(10,50,30,500,this.time,this.time/(600-(this.level*50)))};this.draw_text=function(c,b){var a=b[3];this.ctx.save();this.ctx.shadowOffsetX=4;this.ctx.shadowOffsetY=4;this.ctx.shadowBlur=5;this.ctx.shadowColor="rgba(0, 0, 0, 1)";this.ctx.font="normal "+a+" Arial";this.ctx.fillText(c,b[0],b[1]+b[3]);this.ctx.restore()};this.drawPage=function(){this.ctx.save();this.ctx.shadowOffsetX=3;this.ctx.shadowOffsetY=4;this.ctx.shadowBlur=10;this.ctx.shadowColor="rgba(0, 0, 0, 0.3)";this.ctx.clearRect(0,0,480,650);this.ctx.fillStyle="rgba(0, 0, 0, 0.2)";this.ctx.fillRect(0,0,480,650);this.ctx.restore();for(var c=0;c<this.data.length;c++){var a=c%this.width;var d=Math.floor(c/this.width);var b=this.data[c];if(b!=0){this.drawOne(b,a,d)}}this.drawToolbar();this.draw_image(this.img_soundon,this.rect_sound)};this.draw_bg=function(a){this.ctx.clearRect(a[0],a[1],a[2],a[3]);this.ctx.save();this.ctx.shadowOffsetX=3;this.ctx.shadowOffsetY=4;this.ctx.shadowBlur=10;this.ctx.shadowColor="rgba(0, 0, 0, 0.3)";this.ctx.fillStyle="rgba(0, 0, 0, 0.2)";this.ctx.fillRect(a[0],a[1],a[2],a[3]);this.ctx.restore()};this.draw_image=function(a,b){this.draw_bg(b);this.ctx.drawImage(a,b[0],b[1],b[2],b[3])};this.check_connect=function(c,g){var a=new Date().getTime();var f=this.gobj.get_path(this.cur_pos,c+g*this.width);var d=new Date().getTime()-a;console.log("RUn: "+d+"ms");return f};this.draw_path=function(f){this.ctx.beginPath();var g=f[0];var b=g%this.width;var h=Math.floor(g/this.width);this.ctx.moveTo(b*50+25,h*50+25);var c=500/f.length;this.data[f[0]]=0;this.data[f[f.length-1]]=0;var d=1;var e=this;function a(){var j=f[d];var i=j%e.width;var k=Math.floor(j/e.width);e.ctx.lineTo(i*50+25,k*50+25);e.ctx.stroke();if(d<f.length){d++;setTimeout(a,c)}else{e.ctx.closePath();setTimeout(function(){e.drawPage();if(e.removenum==40){e.gamewin()}},c)}}a();if(this.has_sound){this.sound_ok.play()}};this.drawSelect=function(a,d){var c=a+d*this.width;if(this.data[c]==0){return}if(this.cur_pos==c){this.draw_norm(this.cur_pos);this.cur_pos=-1;this.cur_img=-1}else{if(this.cur_pos===-1){this.cur_pos=c;this.cur_img=this.data[this.cur_pos];this.draw_out(this.cur_pos)}else{var b=this.check_connect(a,d);if(this.cur_img==this.data[c]&&b.length>0){this.removenum+=1;this.score+=10;this.time+=5;this.draw_path(b)}else{this.draw_norm(this.cur_pos);if(this.has_sound){this.sound_error.play()}}this.cur_pos=-1;this.cur_img=-1}}}}$(function(){llk=new LLK();llk.init();$("#btn").click(function(){var a=llk.gobj.find_one_path();console.log("FUCK:"+a);llk.draw_out(llk.data[a[0]],a[0]%llk.width,Math.floor(a[0]/llk.width),40,44);llk.draw_out(llk.data[a[1]],a[1]%llk.width,Math.floor(a[1]/llk.width),40,44)})});